<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTV - Real-Time Virtual Try-On</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            text-align: center;
            margin: 0;
        }

        .header p {
            text-align: center;
            color: #666;
            margin-top: 5px;
        }

        .container {
            flex: 1;
            display: flex;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .video-section {
            flex: 2;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        #outputVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .video-controls {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .stats {
            margin-top: 15px;
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .garment-section {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow-y: auto;
            max-height: calc(100vh - 180px);
        }

        .garment-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .garment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .garment-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .garment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .garment-card.active {
            border-color: #667eea;
            background: #e8ebfc;
        }

        .garment-image {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: contain;
            background: white;
            border-radius: 8px;
        }

        .garment-name {
            margin-top: 8px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-connected {
            background: #2ecc71;
            box-shadow: 0 0 10px #2ecc71;
        }

        .status-disconnected {
            background: #e74c3c;
        }

        .hidden {
            display: none;
        }

        video {
            display: none;
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            
            .garment-section {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé≠ RTV - Real-Time Virtual Try-On</h1>
        <p>
            <span class="status-indicator" id="statusIndicator"></span>
            <span id="statusText">Connecting...</span>
        </p>
    </div>

    <div class="container">
        <div class="video-section">
            <div class="video-container">
                <canvas id="outputVideo"></canvas>
            </div>
            
            <div class="video-controls">
                <button class="btn btn-primary" id="startBtn">
                    üìπ Start Camera
                </button>
                <button class="btn btn-danger hidden" id="stopBtn">
                    ‚èπÔ∏è Stop
                </button>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="fpsValue">0</div>
                    <div class="stat-label">FPS</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="garmentName">-</div>
                    <div class="stat-label">Current Garment</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="latencyValue">0ms</div>
                    <div class="stat-label">Latency</div>
                </div>
            </div>
        </div>

        <div class="garment-section">
            <h2>üëî Select Garment</h2>
            <div class="garment-grid" id="garmentGrid">
                {% for garment in garments %}
                <div class="garment-card {% if loop.index0 == 0 %}active{% endif %}" 
                     data-garment-id="{{ garment.id }}" 
                     data-garment-name="{{ garment.name }}">
                    <img src="/assets/garment_images/{{ garment.image }}" 
                         alt="{{ garment.name }}" 
                         class="garment-image">
                    <div class="garment-name">{{ garment.name }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <video id="webcam" autoplay playsinline></video>

    <script>
        const socket = io();
        const webcam = document.getElementById('webcam');
        const canvas = document.getElementById('outputVideo');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const fpsValue = document.getElementById('fpsValue');
        const garmentName = document.getElementById('garmentName');
        const latencyValue = document.getElementById('latencyValue');

        let streaming = false;
        let frameCount = 0;
        let startTime = Date.now();
        let currentGarment = 0;
        let processing = false;  // Add flag to prevent frame overflow

        // Socket events
        socket.on('connect', () => {
            statusIndicator.className = 'status-indicator status-connected';
            statusText.textContent = 'Connected to GPU Server';
        });

        socket.on('disconnect', () => {
            statusIndicator.className = 'status-indicator status-disconnected';
            statusText.textContent = 'Disconnected';
        });

        socket.on('processed_frame', (data) => {
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                // Update FPS
                frameCount++;
                if (frameCount % 30 === 0) {
                    const elapsed = (Date.now() - startTime) / 1000;
                    const fps = (frameCount / elapsed).toFixed(1);
                    fpsValue.textContent = fps;
                }
                
                processing = false;  // Ready for next frame
            };
            img.src = data.image;
        });

        // Start camera
        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 1280, height: 720 } 
                });
                webcam.srcObject = stream;
                streaming = true;
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                processFrames();
            } catch (err) {
                alert('Camera access denied: ' + err.message);
            }
        });

        // Stop camera
        stopBtn.addEventListener('click', () => {
            const stream = webcam.srcObject;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            streaming = false;
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
        });

        // Process frames
        function processFrames() {
            if (!streaming || processing) {
                if (streaming) {
                    setTimeout(processFrames, 33);  // Try again soon
                }
                return;
            }

            processing = true;  // Mark as processing

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = webcam.videoWidth;
            tempCanvas.height = webcam.videoHeight;
            
            if (tempCanvas.width === 0 || tempCanvas.height === 0) {
                processing = false;
                setTimeout(processFrames, 100);
                return;
            }
            
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(webcam, 0, 0);
            
            const dataUrl = tempCanvas.toDataURL('image/jpeg', 0.7);
            socket.emit('video_frame', dataUrl);
            
            setTimeout(processFrames, 100);  // ~10 FPS to avoid overwhelming
        }

        // Garment selection
        document.querySelectorAll('.garment-card').forEach(card => {
            card.addEventListener('click', () => {
                const garmentId = parseInt(card.dataset.garmentId);
                const garmentNameText = card.dataset.garmentName;
                
                // Update UI
                document.querySelectorAll('.garment-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                garmentName.textContent = garmentNameText;
                
                // Send to server
                fetch(`/api/change_garment/${garmentId}`)
                    .then(response => response.json())
                    .then(data => console.log('Garment changed:', data));
            });
        });

        // Set initial garment name
        const firstGarment = document.querySelector('.garment-card.active');
        if (firstGarment) {
            garmentName.textContent = firstGarment.dataset.garmentName;
        }
    </script>
</body>
</html>
